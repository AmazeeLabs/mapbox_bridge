<?php

/**
 * Implements hook_menu().
 */
function mapbox_bridge_menu() {

  $items['admin/config/user-interface/mapbox_bridge'] = array(
    'title' => 'Mapbox Bridge',
    'description' => 'Configure Mapbox',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('mapbox_bridge_admin_settings'),
    'access arguments' => array('administer'),
    'file' => 'mapbox_bridge.admin.inc',
  );

  $items['mapbox_bridge_ajax_content'] = array (
    'page callback' => 'mapbox_bridge_ajax_content',
    'page arguments' => array(1, 2),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );

  return $items;
}

/**
 * Custom function to load content
 * */
function mapbox_bridge_ajax_content($viewmode, $nid) {
  $node = entity_load_single('node', $nid);
  $rendered = entity_view('node', array($node), $viewmode);

  // dont "return" it or otherwise it will display the whole page
  print render($rendered);
}

/**
 * Custom function to draw the map
 * */
function mapbox_bridge_render_map($map_id, $data = FALSE, $type, $legend = FALSE, $max_zoom = 12, $popup = FALSE) {
  if ($map_id && $type) {
    // add mapbox.js files
    drupal_add_js('https://api.tiles.mapbox.com/mapbox.js/v2.1.7/mapbox.js', 'external');
    drupal_add_css('https://api.tiles.mapbox.com/mapbox.js/v2.1.7/mapbox.css', 'external');

    // add $map_id and token to javascript settings
    drupal_add_js(array('mapboxBridge' => array(
      'mapId' => $map_id,
      'data' => $data ? json_encode($data) : FALSE,
      'publicToken' => variable_get('mapbox_bridge_public', NULL),
      'legend' => $legend,
      'maxZoom' => $max_zoom,
      'popup' => $popup
    )), 'setting');

    // add mapbox_bridge.behaviours.js which contains the main logic
    drupal_add_js(drupal_get_path('module', 'mapbox_bridge') . '/js/mapbox_bridge.popup.js', array('group' => JS_LIBRARY, 'weight' => -1));
    drupal_add_js(drupal_get_path('module', 'mapbox_bridge') . '/js/mapbox_bridge.behaviours.js', array('group' => JS_LIBRARY, 'weight' => -1));

    // add mapbox_bridge.css for basic style overrides to mapbox
    drupal_add_css(drupal_get_path('module', 'mapbox_bridge') . '/css/mapbox_bridge.css', array('group' => CSS_DEFAULT));

    // div that will contain the map
    return '<div class="mapbox-bridge mapbox-type-' . $type . '" id="map" style="width: 100%; height: 600px;"></div>';
  }
}